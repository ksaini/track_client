<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />
    <!-- Good default declaration:
    * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
    * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
    * Disables use of eval() and inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
        * Enable inline JS: add 'unsafe-inline' to default-src
        * Enable eval(): add 'unsafe-eval' to default-src
    * Create your own at http://cspisawesome.com
    -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: 'unsafe-inline' https://ssl.gstatic.com; style-src 'self' 'unsafe-inline'; media-src *" /> -->
	<script src="./js/jquery.min.js"></script>
	<script src="./assets/js/bootstrap.min.js"></script>
	
	<link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
	<link rel="stylesheet" href="./assets/css/bootstrap.min.css">
	<link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />
	<link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet" />
	<link href="assets/css/demo.css" rel="stylesheet" />


	
    <title>Visit Report</title>
	<style>
	.row {
		margin-right: 5px;
		margin-top: 5px;
		margin-left: 10px;
		}
	.container-fluid {
		padding-right: 0px;
		padding-left: 0px;
	}
	.col-lg-1,
.col-lg-10,
.col-lg-11,
.col-lg-12,
.col-lg-2,
.col-lg-3,
.col-lg-4,
.col-lg-5,
.col-lg-6,
.col-lg-7,
.col-lg-8,
.col-lg-9,
.col-md-1,
.col-md-10,
.col-md-11,
.col-md-12,
.col-md-2,
.col-md-3,
.col-md-4,
.col-md-5,
.col-md-6,
.col-md-7,
.col-md-8,
.col-md-9,
.col-sm-1,
.col-sm-10,
.col-sm-11,
.col-sm-12,
.col-sm-2,
.col-sm-3,
.col-sm-4,
.col-sm-5,
.col-sm-6,
.col-sm-7,
.col-sm-8,
.col-sm-9,
.col-xs-1,
.col-xs-10,
.col-xs-11,
.col-xs-12,
.col-xs-2,
.col-xs-3,
.col-xs-4,
.col-xs-5,
.col-xs-6,
.col-xs-7,
.col-xs-8,
.col-xs-9 {
    position: relative;
    min-height: 1px;
    padding-right: 0px;
    padding-left: 0px;
}
.container-fluid>.navbar-collapse,
.container-fluid>.navbar-header,
.container>.navbar-collapse,
.container>.navbar-header {
    margin-right: 0px;
    margin-left: 0px;
}
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 5px
}
.card .content {
    padding: 10px 10px 5px 5px; }
	</style>
	<script> var c=0;</script>
</head>

<body >

<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      <a class="navbar-brand" href="dashboard.html">GreyBox CLient</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li class="active"><a href="dashboard.html">&nbsp;Home</a></li>
        <li class="dropdown">
		  <a href="index.html" onclick="localStorage['eid']='';document.location='index.html'">&nbsp;&nbsp;Logout</a>
        </li>
        <!----<li><a href="#">&nbsp;&nbsp;View Agents </a></li>---->
      </ul>
      
    </div>
  </div>
</nav>

<div class="content" id='mainbody'>
	<div class="container-fluid">
		
		<div class="tab-content">
			<!-----<div class="panel panel-default tab-pane fade in active" id="default">----->
				<div class="card" >
					<div class="panel-body">
						
						<div class="row " id='searchdiv' >
							<div class="content col-md-10 col-xs-10 ">
								<label>Select Dealer : </label><select class="form-control text-muted input-sm" name='class'  id='class'  style='font-size: 85%;'></select>
							</div>
							<div class="content col-md-2 col-xs-2 "><br><button type='button'   onClick="getDealer()">Go</button></div>
						</div>
					<div class="tab-content" id='info' style='display:none;'>
						<ul class="nav nav-tabs" style='font-size: 85%;'>					
							<li class='active'><a data-toggle='tab' href='#one' style='color:black;'><small>Discussions</small></a></li>
							<li><a data-toggle='tab' href='#two' style='color:black;' id="t1"><small>Orders</small></a></li>
							<li><a data-toggle='tab' href='#three' style='color:black;' id="t2"><small>Next Visit</small></a></li>
							
						</ul><br>
						<div class="panel panel-default tab-pane fade in active" id="one" style="border-style: none">
						<div class="row " >
							<div class="content col-md-9 col-xs-9 ">
								<select class="form-control text-muted input-sm" name='contact'  id='contact'  style='font-size: 85%;'></select><br>
							</div>
							<div class="content col-md-1 col-xs-1 ">
								<button type='button-sm ' onclick="document.getElementById('t1').click();return false;" class='btn btn-sm btn-positive pull-left' >+Contact</button>
							</div>
						</div>
						<div class="row " >
							<div class="content col-md-12 col-xs-12 ">
							<textarea class="form-control" rows="5" id="discussion"></textarea>
							</div>
						</div><br>
						<button type='button-sm ' onclick="document.getElementById('t1').click();return false;" class='btn btn-sm btn-positive pull-right' >Next</button>
						</div>
						
						<div class="panel panel-default tab-pane fade in " id="two">
							<!---<div class="card" style="padding: 5px 5px 10px 10px;">--->
						<br>
					<div class="form-group row" style="margin-bottom:1px">
						<div class="col-xs-8">
							<label for="ex1">Item List<br>.</label><br>
							
						</div>
						<div class="col-xs-2">
							<label for="ex2">Qty</label><br>
							
						</div>
						<div class="col-xs-2">
							<label for="ex2">Price</label><br>
						</div>
						
					</div>
					<div class="form-group row">
						<div class="col-xs-7">
							<select class="form-control text-muted input-sm" name='order'  id='order'  style='font-size: 85%;'></select>
						</div>
						<div class="col-xs-2">
							<input class="form-control text-muted input-sm" id="qty" type="text" style='font-size: 85%;'>
						</div>
						<div class="col-xs-2">
							<input class="form-control text-muted input-sm" id="price" type="text" style='font-size: 85%;'>
						</div>
						<div class="col-xs-1" style='font-size: 125%;text-align:center'>
							<a href="#" onclick='addorder();' style='font-size:10px; ' >Add</a>
						</div>
					</div>
					<div class="form-group row text-muted" id='newitem' style='font-size: 75%;'><br>
					
					</div><br>
					<script>
					function addorder(){
						var item = document.getElementById('order').value;
						var qty = document.getElementById('qty').value;
						var price = document.getElementById('price').value;
						
						var e = document.getElementById("order");
						var itemname = e.options[e.selectedIndex].text;
						c=c+1;
						
						document.getElementById('newitem').innerHTML += "<div id='item"+c+"'><div class='col-xs-7' id='ii"+c+"'>" + itemname + "</div><div class='col-xs-2' id='qq"+c+"'>"+ qty + "</div><div class='col-xs-2' id='pp"+c+"'>" + price +"</div><div class='col-xs-1' style='font-size: 125%;text-align:center'><a href='#' onclick='removeorder(this);'>-</a></div></div><br>";
						
					}	
					</script>
					
                <!----</div>---->
						<button type='button-sm ' onclick="document.getElementById('t2').click();return false;" class='btn btn-sm btn-positive pull-right' >Next</button>
						</div>
						
						<div class="panel panel-default tab-pane fade in " id="three" style="border-style: none">
						
							<div class="form-group row" style="margin-bottom:5px">
								<div class="col-xs-8 text-muted " style='font-size: 65%;'>
								 <input  type="checkbox" name="nxtvisit" id="nxtvisit" value="1" onclick="handleClick(this);"> &nbsp;Schedule Next Visit<br><br><br>
								</div>
							</div>	
							<div class="form-group row text-muted"  style="margin-bottom:5px;font-size: 85%;" >
								<input type="date" id='r2' name="nxtdate" disabled>
								<label style="font-size: 95%;" > &nbsp;&nbsp;Schedult a Date</label>
							</div>
							
							<div class="form-group row"  style="margin-bottom:5px" >
								<textarea class="form-control" id='r3' rows="5"  placeholder="To do for next visit." disabled></textarea>
							</div>
							
							<div class="form-group row" style="margin-bottom:15px"><br>
								<button type='button-sm ' class='text-muted btn btn-sm btn-positive' id="savevisit"   onClick="getLocation();"  >Save Visit</button><br><br>
							</div>
							<div id="errmsg" style="font-size:10px;color:red;" ></div>
							
						</div>
							
							</div>
						</div>
						
						
					</div>
					</div>
				</div>
					
			<!----</div>---->	
	</div>	
</div>

</body>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="js/dataTbl.js"></script>

<script>
	pingloc();
	var did;
		
	try{
	    var dataArray=JSON.parse(localStorage.getItem("dealers"));
		updateDD(dataArray,'class');
	} catch(err){}
	
	var req = new XMLHttpRequest();
		req.onreadystatechange = function() {
		if (req.readyState == 4 && req.status == 200) {
			var dataArray=JSON.parse(req.responseText);
			localStorage.setItem("dealers",req.responseText);
			updateDD(dataArray,'class');
		}
		
		};
		
		req.open("GET", base_url + "/getTbl.php?agentid="+ localStorage["sid"], true);
		req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		req.send();

</script>
<script>


function handleClick(cb) {
  if(cb.checked){
	document.getElementById('r2').disabled = false;
	document.getElementById('r3').disabled = false;
  }
  else{
	document.getElementById('r2').disabled = true;
	document.getElementById('r3').disabled = true;
  }
}

function getLocation(){
		
	 /** if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(saveVisit,onError, { timeout: 4000 });
	  } else {
			document.getElementById('errmsg').innerHTML = "ERROR: Unable to get device location. Enable GPRS.";
	  }	
	  **/
     // navigator.geolocation.getCurrentPosition(saveVisit,onError);
	 navigator.geolocation.getCurrentPosition(saveVisit,onError, { timeout: 4000 });
}
function onError(error) {
		document.getElementById('errmsg').innerHTML = "Some error in Location ." + error.message + " err code : " + error.code;
		loc = ["0","0"];
		document.getElementById('errmsg').innerHTML = "Unable to get device location. Enable GPRS.";			
    }

	  
function getDealer(){
		
		did = document.getElementById('class').value;

		var req = new XMLHttpRequest();
		req.onreadystatechange = function() {
		if (req.readyState == 4 && req.status == 200) {
			var data=JSON.parse(req.responseText);
			displayDealer(data[0]['firmname'],data[0]['addr']);
			getDropDownData('contact','__!dealer_contact_01,' + did + ';');
		}
		
		};
		//var base_url = "http://theqalabs.com/track/";
		req.open("GET", base_url + "/getTbl.php?did="+ did, true);
		req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		req.send();
  
}

function displayDealer(fname,addr){
	var d = "<div class='row ' ><div class='content col-md-4 col-xs-4'><label>Firm Name : </label>";
			d += "<p style='font-size:75%'>" + fname + "...</p></div>";
			d += "<div class='content col-md-6 col-xs-6'><label>Address : </label>";
			d += "<p style='font-size:70%'>" + addr + "</p></div>";
			d += "<div class='content col-md-2 col-xs-2'><img src='./img/search.png' class='img-responsive' width='20' height='20' onclick='location.reload();' >";
			d +="</div></div>";
			document.getElementById('info').style.display = 'block' ;
			document.getElementById('searchdiv').innerHTML=d;
}
function removeorder(ele){
	var e = ele.parentNode.parentNode;
	var element = e;//document.getElementById("item1");
	element.parentNode.removeChild(element);
	c--;
}

function saveVisit(position){
	document.getElementById('errmsg').innerHTML = "Starting Saving";
 
	var discuss  = document.getElementById('discussion').value;
	discuss = encodeURIComponent(discuss);
	var contact = "";
	var e = document.getElementById("contact");
	try{
	 contact = e.options[e.selectedIndex].text;
	}catch(err) {
	 contact =""
	 document.getElementById('errmsg').innerHTML = "Unable to get Contact.";		
	}
	
	//define discussion array
	var discussion = [discuss,contact];
	
	// declear order json
	var order = {
			details: []
		};
	
	var newitem = document.getElementById("newitem");
	var child = newitem.firstChild;
	
	document.getElementById('errmsg').innerHTML = "Before Parsing";
	var str='';
	for(var i=1;i<=c;i++){
		str += document.getElementById('ii'+i).innerHTML + "-" + document.getElementById('qq'+i).innerHTML + "<br>";
		order.details.push({ 
				"item" : document.getElementById('ii'+i).innerHTML,
				"qty"  : HtmlEncode(document.getElementById('qq'+i).innerHTML),
				"price"       : encodeURIComponent(document.getElementById('pp'+i).innerHTML) 
		});
	}
	
	
	// define next visit array
	if(document.getElementById('nxtvisit').checked){
		var visit = [document.getElementById('r2').value,encodeURIComponent(document.getElementById('r3').value)];
	}
	else
		var visit = ['',''];
		
	document.getElementById('errmsg').innerHTML = "After Parsing";	
	
	loc = [position.coords.latitude,position.coords.longitude];
	document.getElementById('errmsg').innerHTML = "loc : " + loc[0];	
	saveMeetingDetails(discussion,order,visit,loc[0],loc[1]);
		
}
function HtmlEncode(s)
{
  var el = document.createElement("div");
  el.innerText = el.textContent = s;
  s = el.innerHTML;
  return s;
}
function preProcess(discussion,order,visit,lat,lng,did){
	var a = new Array();
	
	try{
	if(localStorage.tmp!=null && localStorage.tmp.length >2)
		a = JSON.parse(localStorage.tmp);
		
	a.push([discussion,order,visit,lat,lng, new Date(),did]);
	localStorage.tmp = JSON.stringify(a);	
	
	} catch (e){
		document.getElementById('errmsg').innerHTML = "Error in preProcessing." ;		
	}
}
function postProcess(){
	var a = JSON.parse(localStorage.tmp);
	a.pop();
	localStorage.tmp = JSON.stringify(a);	
}

function saveMeetingDetails(discussion,order,visit,lat,lng){
      
	var q = "discussion=" + JSON.stringify(discussion) + "&order=" + JSON.stringify(order.details) + "&visit=" + JSON.stringify(visit) + "&lat=" + lat + "&long=" + lng + "&did=" + did + "&agent=" + localStorage["sid"];
	document.getElementById('errmsg').innerHTML = "Before Preprocess";
	preProcess(discussion,order,visit,lat,lng,did);
	
	document.getElementById("savevisit").disabled = true;
	syncData(discussion,order,visit,lat,lng,new Date(),did);
}

getDropDownData('order','item_list_01');

function syncData(discussion,order,visit,lat,lng,ts,did)
{
	 var ts = new Date(ts);
	 var agent = localStorage["sid"];
	 ts = ts.getUTCFullYear() + "-" + twoDigits(1 + ts.getUTCMonth()) + "-" + twoDigits(ts.getUTCDate()) + " " + twoDigits(ts.getUTCHours()) + ":" + twoDigits(ts.getUTCMinutes()) + ":" + twoDigits(ts.getUTCSeconds());
	 
	 
	 var q = "discussion=" + JSON.stringify(discussion[0]) + "&contact=" + JSON.stringify(discussion[1]) + "&order=" + JSON.stringify(order.details) + "&nxtvisit=" + visit[0] + "&todo=" + JSON.stringify(visit[1]) + "&lat=" + lat + "&long=" + lng + "&did=" + did + "&agent=" + localStorage["sid"] + "&ts=" + ts;
     //alert(q);	 
	 //document.getElementById('done').disabled = true;
	 var req = new XMLHttpRequest();
	 req.onreadystatechange = function() {
		if (req.readyState == 4 ) {
			if (req.status == 200) {
				if(req.responseText.trim()== "Success"){
					postProcess();
					document.getElementById('mainbody').innerHTML = "<p style='font-size:38px;color:#4CAF50;text-align:center;margin-top:200px;'>Success</p><br><p class='text-muted' style='line-height:1.0;text-align:center'><small>Meeting record saved!!</small></p>";
				}
					else
						document.getElementById('errmsg').innerHTML = "Error in saving. Try to SYNC after sometime." + "<a href='sync.html' class='btn btn-sm'> sync </a>";				
			} else
				document.getElementById('errmsg').innerHTML = "Error in saving. Try to SYNC after sometime." + "<a href='sync.html' class='btn btn-sm'> sync </a>";
		}	
		
	 };
		
		req.open("POST", base_url + "/fallBack1.php", true);
		req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		req.send(q);
}	
function twoDigits(d) {
    if(0 <= d && d < 10) return "0" + d.toString();
    if(-10 < d && d < 0) return "-0" + (-1*d).toString();
    return d.toString();
}

</script>
 
</html>